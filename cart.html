<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlayWithEase - Cart</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
--bg:#f8fafc;
--card:#ffffff;
--accent:#2563eb;
--text:#0f172a;
}

body{
font-family:'Poppins',sans-serif;
background:var(--bg);
color:var(--text);
transition:.3s;
min-height:100vh;
}

body.theme-dark{--bg:#0f172a;--card:#1e293b;--accent:#3b82f6;--text:#f1f5f9;}
body.theme-emerald{--accent:#10b981;}
body.theme-royal{--accent:#7c3aed;}
body.theme-elite-red{--bg:#14090b;--card:#1f1114;--accent:#dc2626;--text:#fef2f2;}

.header{
display:flex;
justify-content:space-between;
align-items:center;
padding:20px;
flex-wrap:wrap;
}

.brand{
font-family:'Orbitron';
font-size:20px;
font-weight:900;
text-decoration:none;
color:inherit;
}

.theme-btn{
padding:8px 16px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,var(--accent),#1d4ed8);
color:#fff;
font-weight:600;
cursor:pointer;
margin-top:10px;
}

.container{
max-width:1000px;
margin:auto;
padding:20px;
}

.cart-item{
background:var(--card);
border-radius:15px;
padding:15px;
margin-bottom:15px;
display:flex;
gap:15px;
align-items:center;
box-shadow:0 10px 25px rgba(0,0,0,.08);
flex-wrap:wrap;
}

.cart-item img{
width:120px;
border-radius:10px;
}

.item-info{flex:1;min-width:200px;}
.item-name{font-weight:600;margin-bottom:5px;}

.qty-box{
display:flex;
gap:8px;
margin-top:8px;
}

.qty-btn{
background:var(--accent);
border:none;
color:#fff;
padding:4px 10px;
border-radius:6px;
cursor:pointer;
}

.remove-btn{
background:#ef4444;
border:none;
color:#fff;
padding:5px 10px;
border-radius:6px;
cursor:pointer;
margin-top:8px;
}

.summary{
margin-top:25px;
background:var(--card);
padding:20px;
border-radius:15px;
box-shadow:0 10px 25px rgba(0,0,0,.1);
}

.summary-row{
display:flex;
justify-content:space-between;
margin-bottom:8px;
}

.total{
font-weight:700;
font-size:18px;
}

.checkout-btn{
width:100%;
padding:12px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,var(--accent),#1d4ed8);
color:#fff;
font-weight:700;
cursor:pointer;
margin-top:15px;
}

.payment-icons{
margin-top:10px;
text-align:center;
font-size:14px;
opacity:.7;
}

/* OVERLAY */
.overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
padding:15px;
}

.modal{
background:var(--card);
padding:20px;
border-radius:15px;
width:100%;
max-width:360px;
text-align:center;
}

.modal img{
width:180px;
margin-top:10px;
border-radius:10px;
}

.timer{
margin-top:8px;
font-weight:600;
color:var(--accent);
}

.modal-note{
margin-top:8px;
font-size:13px;
opacity:.8;
}

.modal-btn{
width:100%;
margin-top:8px;
padding:8px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
}

.cancel{background:#ef4444;color:#fff;}
.paid{background:var(--accent);color:#fff;}
.back{background:#111;color:#fff;}

@media(max-width:600px){
.cart-item{flex-direction:column;align-items:flex-start;}
.cart-item img{width:100%;}
}
</style>
</head>

<body>

<div class="header">
<a href="index.html" class="brand">PlayWithEaseÂ®</a>
<button id="themeSwitcher" class="theme-btn">Theme</button>
</div>

<div class="container">
<h2>Your Cart</h2>
<div id="cartContainer"></div>

<div class="summary" id="summaryBox" style="display:none;">
<div class="summary-row">
<span>Subtotal</span>
<span id="subtotal"></span>
</div>
<div class="summary-row">
<span>GST</span>
<span>Not Applicable</span>
</div>
<div class="summary-row total">
<span>Total</span>
<span id="grandTotal"></span>
</div>

<button class="checkout-btn" onclick="openPayment()">Secure Checkout</button>

<div class="payment-icons">
UPI â€¢ RuPay â€¢ Visa â€¢ Credit Card
</div>

</div>
</div>

<div class="overlay" id="paymentOverlay">
<div class="modal">
<h3>Complete Your Payment</h3>
<p><b>UPI ID:</b> shayanff98@okhdfcbank</p>
<img id="upiQR">
<div class="timer" id="countdown">10:00</div>
<div class="modal-note">
Scan & pay securely via UPI. Amount auto-filled.  
Powered by PlayWithEase Secure Gateway.
</div>

<button class="modal-btn paid" onclick="confirmPaid()">I've Paid</button>
<button class="modal-btn cancel" onclick="closePayment()">Cancel Payment</button>
<button class="modal-btn back" onclick="window.location.href='index.html'">Back to Store</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
getFirestore, 
collection, 
addDoc, 
serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyAxuYwom2tuGTz3Nsi-6ndYSwK7BkEJIVs",
authDomain:"playwithease.firebaseapp.com",
projectId:"playwithease"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


/* ðŸ”¥ NEW CONFIRM PAID FUNCTION */
window.confirmPaid = async function(){

let cart = JSON.parse(localStorage.getItem("pwe_cart")) || [];

if(cart.length === 0){
alert("Cart empty");
return;
}

let total = cart.reduce((sum,item)=>sum + item.price*item.qty,0);

let user = auth.currentUser;

if(!user){
alert("Login required");
return;
}

try{

await addDoc(collection(db,"orders"), {
userEmail: user.email,
items: cart,
total: total,
status: "in-progress",
createdAt: serverTimestamp()
});

alert("Order placed successfully!");

localStorage.removeItem("pwe_cart");

window.location.href = "order-history.html";

}catch(err){
console.error(err);
alert("Order save failed");
}

}

let cart = JSON.parse(localStorage.getItem("pwe_cart")) || [];

function renderCart(){
const container=document.getElementById("cartContainer");
const subtotalEl=document.getElementById("subtotal");
const totalEl=document.getElementById("grandTotal");
const summary=document.getElementById("summaryBox");

container.innerHTML="";
if(cart.length===0){summary.style.display="none";return;}
summary.style.display="block";

let subtotal=0;
cart.forEach((item,index)=>{
subtotal+=item.price*item.qty;
container.innerHTML+=`
<div class="cart-item">
<img src="${item.image}">
<div class="item-info">
<div class="item-name">${item.name}</div>
<div>â‚¹${item.price}</div>
<div class="qty-box">
<button class="qty-btn" onclick="changeQty(${index},-1)">-</button>
<span>${item.qty}</span>
<button class="qty-btn" onclick="changeQty(${index},1)">+</button>
</div>
<button class="remove-btn" onclick="removeItem(${index})">Remove</button>
</div>
</div>`;
});

subtotalEl.innerText="â‚¹"+subtotal;
totalEl.innerText="â‚¹"+subtotal;
}

window.openPayment=function(){
let total = cart.reduce((s,i)=>s+i.price*i.qty,0);
document.getElementById("paymentOverlay").style.display="flex";

/* AUTO AMOUNT CAPTURE QR */
document.getElementById("upiQR").src=
`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
`upi://pay?pa=shayanff98@okhdfcbank&pn=PlayWithEase&am=${total}&cu=INR&tn=Payment%20for%20PlayWithEase%20Order`
)}`;

startTimer(600);
};

window.closePayment=function(){
document.getElementById("paymentOverlay").style.display="none";
clearInterval(timerInterval);
};

let timerInterval;
function startTimer(seconds){
let time=seconds;
timerInterval=setInterval(()=>{
let min=Math.floor(time/60);
let sec=time%60;
document.getElementById("countdown").innerText=
(min<10?"0":"")+min+":"+(sec<10?"0":"")+sec;
time--;
if(time<0)clearInterval(timerInterval);
},1000);
}

window.confirmPaid = async function(){
let total = cart.reduce((s,i)=>s+i.price*i.qty,0);
let user = auth.currentUser;

let orderData={
userEmail:user?user.email:"Guest",
items:cart,
total:total,
status:"Pending",
createdAt:serverTimestamp()
};

let docRef = await addDoc(collection(db,"orders"),orderData);

let msg=`Hello PlayWithEase Team,%0AOrder ID: ${docRef.id}%0ATotal Paid: â‚¹${total}%0AUPI ID: shayanff98@okhdfcbank%0AProfessional Digital Delivery Requested.%0APlease confirm my order.`;

window.location.href=`https://wa.me/917001568884?text=${msg}`;
};

/* THEME */
const themes=["","theme-dark","theme-emerald","theme-royal","theme-elite-red"];
let currentTheme=0;
document.getElementById("themeSwitcher").addEventListener("click",()=>{
currentTheme++;
if(currentTheme>=themes.length)currentTheme=0;
document.body.className=themes[currentTheme];
});

renderCart();
</script>

</body>
</html>
