<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Cart | PlayWithEase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Poppins,Arial;background:#f8fafc;margin:0}
header{background:#2563eb;color:#fff;padding:16px}
.container{max-width:900px;margin:20px auto;padding:0 16px}
.item{background:#fff;padding:14px;border-radius:12px;margin-bottom:10px}
.total{font-size:18px;font-weight:700;margin-top:16px}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  margin-top:16px;
}
.pay{background:#16a34a;color:#fff}
</style>
</head>

<body>

<header>
  <h2>ðŸ›’ Your Cart</h2>
</header>

<div class="container" id="box"></div>

<!-- ðŸ”¥ FIREBASE CORE (ONE TIME) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAxuYwom2tuGTz3Nsi-6ndYSwK7BkEJIVs",
  authDomain: "playwithease.firebaseapp.com",
  projectId: "playwithease"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const box = document.getElementById("box");

/* LOAD CART */
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

if(cart.length === 0){
  box.innerHTML = "<p>Your cart is empty</p>";
}else{
  let total = 0;
  cart.forEach(i=>{
    total += Number(i.price);
    box.innerHTML += `
      <div class="item">
        <b>${i.name}</b><br>
        â‚¹${i.price}
      </div>
    `;
  });

  box.innerHTML += `
    <div class="total">Total: â‚¹${total}</div>
    <button class="btn pay" onclick="paid()">Iâ€™ve Paid</button>
  `;
}

/* PAY FUNCTION */
window.paid = function(){
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      alert("Please login first");
      return;
    }

    let total = cart.reduce((s,i)=>s+Number(i.price),0);

    // ðŸ”¥ SAVE ORDER FIRST
    await addDoc(collection(db,"orders"),{
      userId: user.uid,
      userEmail: user.email,
      items: cart,
      total: total,
      status: "in-progress",
      createdAt: serverTimestamp()
    });

    localStorage.removeItem("cart");

    let msg = "Hi PlayWithEase ðŸ‘‹\n\nI have completed payment.\n\n";
    cart.forEach((i,idx)=>{
      msg += `${idx+1}. ${i.name} â€“ â‚¹${i.price}\n`;
    });
    msg += `\nTotal: â‚¹${total}`;

    window.open(
      "https://wa.me/917001568884?text=" + encodeURIComponent(msg),
      "_blank"
    );
  });
};
</script>

</body>
</html>
