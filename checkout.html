<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | PlayWithEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { background: #020617; color: white; font-family: 'Outfit'; }</style>
</head>
<body class="p-4 md:p-8 max-w-4xl mx-auto">
    <a href="index.html" class="flex items-center gap-2 text-gray-400 mb-6 hover:text-white"><i data-lucide="arrow-left"></i> Back to Store</a>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-[#0f172a] border border-white/10 rounded-2xl p-6 h-fit">
            <h2 class="text-xl font-bold mb-4">Order Summary</h2>
            <div id="checkout-items" class="space-y-3 text-sm text-gray-300"></div>
            <div class="border-t border-white/10 mt-4 pt-4 flex justify-between text-xl font-bold">
                <span>Total</span>
                <span id="checkout-total" class="text-brand-400">₹0</span>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-[#0f172a] border border-white/10 rounded-2xl p-6">
                <h3 class="font-bold mb-4">Contact Details</h3>
                <input type="text" id="name" placeholder="Full Name" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg mb-3 text-white" required>
                <input type="email" id="email" placeholder="Email Address" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white" readonly>
            </div>

            <div class="bg-[#0f172a] border border-white/10 rounded-2xl p-6">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="qr-code"></i> UPI Payment</h3>
                
                <div class="bg-white p-4 rounded-xl w-fit mx-auto mb-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=shayanff98@okhdfcbank&pn=PlayWithEase" alt="UPI QR">
                </div>
                
                <div class="flex items-center justify-between bg-black/40 p-3 rounded-lg border border-white/10">
                    <span class="text-sm text-gray-400 font-mono">shayanff98@okhdfcbank</span>
                    <button onclick="navigator.clipboard.writeText('shayanff98@okhdfcbank')" class="text-brand-400 text-xs font-bold uppercase hover:text-white">Copy</button>
                </div>

                <p class="text-xs text-gray-500 mt-4 text-center">Scan with GPay, PhonePe, or Paytm</p>
            </div>

            <button id="confirm-btn" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold shadow-lg shadow-green-600/20 flex items-center justify-center gap-2">
                <i data-lucide="message-circle"></i> Confirm via WhatsApp
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp({ apiKey: "AIzaSyAxuYwom2tuGTz3Nsi-6ndYSwK7BkEJIVs", projectId: "playwithease" });
        const auth = getAuth(app);
        const db = getFirestore(app);

        let cart = JSON.parse(localStorage.getItem('pwe_cart')) || [];
        const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);

        // Render Summary
        document.getElementById('checkout-items').innerHTML = cart.map(i => `
            <div class="flex justify-between"><span>${i.qty}x ${i.name}</span><span>₹${i.price * i.qty}</span></div>
        `).join('');
        document.getElementById('checkout-total').innerText = '₹' + total;

        // User Auto-fill
        onAuthStateChanged(auth, (user) => {
            if(user) document.getElementById('email').value = user.email;
        });

        // Handle Order
        document.getElementById('confirm-btn').addEventListener('click', async () => {
            if(cart.length === 0) return alert("Cart is empty");
            
            const btn = document.getElementById('confirm-btn');
            btn.innerHTML = "Processing...";
            btn.disabled = true;

            try {
                // 1. Save to Firebase
                const orderData = {
                    items: cart,
                    total: total,
                    customer: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    date: serverTimestamp(),
                    status: 'pending_verification'
                };
                const docRef = await addDoc(collection(db, 'orders'), orderData);
                const orderID = docRef.id.slice(0,6).toUpperCase();

                // 2. Redirect to WhatsApp
                const msg = `Hello PlayWithEase, I have placed order #${orderID} for ₹${total}.\nPayment done via UPI (shayanff98@okhdfcbank).\nPlease confirm my order.`;
                const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
                
                localStorage.removeItem('pwe_cart');
                window.location.href = 'order-success.html?id=' + orderID;
                window.open(url, '_blank'); // Open WA in new tab

            } catch (e) {
                console.error(e);
                alert("Order failed. Try again.");
                btn.disabled = false;
            }
        });
        lucide.createIcons();
    </script>
</body>
</html>
